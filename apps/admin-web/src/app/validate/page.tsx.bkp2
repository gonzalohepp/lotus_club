'use client'

import { useCallback, useEffect, useRef, useState } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import AdminLayout from '../layouts/AdminLayout'
import { supabase } from '@/lib/supabaseClient'
import { Card, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { CheckCircle, XCircle, RefreshCw, Camera } from 'lucide-react'
import QRScannerHtml5 from '@/components/QRScannerHtml5'

type MemberRow = {
  user_id: string
  first_name: string | null
  last_name: string | null
  email: string | null
  access_code: string | null
  status?: string | null
}

const fullName = (m: MemberRow | null) =>
  m ? [m.first_name ?? '', m.last_name ?? ''].join(' ').trim() || 'Miembro' : 'Miembro'

export default function ValidatePage() {
  const router = useRouter()
  const qp = useSearchParams()

  // Estado UI
  const [paused, setPaused] = useState(false)
  const [cameraError, setCameraError] = useState<string | null>(null)

  // Resultado
  const [openResult, setOpenResult] = useState(false)
  const [allowed, setAllowed] = useState<boolean | null>(null)
  const [resultMsg, setResultMsg] = useState('')

  // Datos usuario / miembro
  const [member, setMember] = useState<MemberRow | null>(null)
  const [userEmail, setUserEmail] = useState<string | null>(null)

  // Anti-loop
  const processingRef = useRef(false)
  const lastTextRef = useRef<string | null>(null)
  const lastAtRef = useRef<number>(0)

  // ========= Sesión y preload del miembro ========
  useEffect(() => {
    ;(async () => {
      const { data } = await supabase.auth.getUser()
      const email = data.user?.email ?? null
      setUserEmail(email)
      if (!email) {
        router.replace('/login')
        return
      }
      const { data: rows, error } = await supabase
        .from('members_with_status')
        .select('*')
        .ilike('email', email)
        .limit(1)

      if (error) console.error('[validate] preload error', error)
      setMember((rows?.[0] as MemberRow) ?? null)
    })()
  }, [router])

  // ========= Parser del QR =========
  const parseQR = (raw: string) => {
    try {
      const u = new URL(raw)
      const tok = u.searchParams.get('t') || undefined
      return { token: tok }
    } catch {
      const txt = (raw ?? '').trim()
      if (txt.includes('@')) return { email: txt }
      return { code: txt || undefined }
    }
  }

  // ========= Validación =========
  const validateAccess = useCallback(
    async (rawText: string) => {
      if (processingRef.current) return
      processingRef.current = true

      try {
        const parsed = parseQR(rawText)
        const emailToCheck = parsed.email || userEmail || member?.email || undefined
        const codeToCheck = parsed.code || member?.access_code || undefined

        let ok = false
        let reason = 'QR inválido'
        let m: MemberRow | null = null

        if (emailToCheck || codeToCheck) {
          const { data: row, error } = await supabase
            .from('members_with_status')
            .select('*')
            .or(`email.ilike.${emailToCheck ?? '___'},access_code.eq.${codeToCheck ?? '___'}`)
            .limit(1)
            .maybeSingle()

          if (error) {
            console.error('[validate] query error', error)
            throw error
          }

          m = (row as MemberRow) ?? null
          if (m) {
            if (m.status === 'suspendido') { ok = false; reason = 'Membresía suspendida' }
            else if (m.status === 'vencido') { ok = false; reason = 'Cuota vencida' }
            else { ok = true; reason = 'Acceso autorizado - ¡Bienvenido!' }
            setMember(m)
          } else {
            ok = false
            reason = 'No se encontró el miembro'
          }
        }

        // Log asíncrono (no bloquea UX)
        supabase.from('access_logs').insert({
          user_id: m?.user_id ?? member?.user_id ?? null,
          result: ok ? 'autorizado' : 'denegado',
          reason,
          scanned_at: new Date().toISOString(),
        }).then().catch(() => {})

        setAllowed(ok)
        setResultMsg(reason)
        setOpenResult(true)

        if (ok) {
          // no reanudamos cámara; redirigimos suave
          setTimeout(() => router.replace('/profile'), 900)
        }
      } catch (e) {
        console.error('[validate] unexpected error', e)
        setAllowed(false)
        setResultMsg('Error interno al validar')
        setOpenResult(true)
      } finally {
        processingRef.current = false
      }
    },
    [member, router, userEmail]
  )

  // ========= Callback del scanner (con debounce) =========
  const handleDecode = useCallback(
    (text: string) => {
      const now = Date.now()
      if (text === lastTextRef.current && now - lastAtRef.current < 2000) return
      lastTextRef.current = text
      lastAtRef.current = now

      setPaused(true) // pausa “soft”
      validateAccess(text)
    },
    [validateAccess]
  )

  // ========= Reintentar cámara =========
  const retryCamera = () => {
    setCameraError(null)
    setPaused(false)
  }

  // Si llegó ?t=... por URL, validamos directamente
  useEffect(() => {
    const t = qp.get('t')
    if (t) handleDecode(`${t}`)
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [qp])

  return (
    <AdminLayout active="/validate">
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-4 md:p-8">
        <div className="max-w-3xl mx-auto">
          <div className="text-center mb-6">
            <h1 className="text-3xl md:text-4xl font-bold text-slate-900 mb-2">Validación de Acceso</h1>
            <p className="text-slate-600">Escaneá el QR para validar tu acceso.</p>
          </div>

          <Card className="shadow-2xl border-none bg-white">
            <CardContent className="p-6 md:p-8">
              {cameraError && (
                <div className="mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700">
                  {cameraError}
                </div>
              )}

              <div className="flex items-center gap-2 mb-4">
                <Button
                  variant="outline"
                  onClick={() => setPaused((p) => !p)}
                  className="inline-flex items-center gap-2"
                >
                  <Camera className="w-4 h-4" />
                  {paused ? 'Reanudar cámara' : 'Pausar cámara'}
                </Button>
                <Button
                  variant="outline"
                  onClick={retryCamera}
                  className="inline-flex items-center gap-2"
                >
                  <RefreshCw className="w-4 h-4" />
                  Reintentar cámara
                </Button>
              </div>

              {/* Scanner contenido */}
              <div className="flex justify-center">
                <QRScannerHtml5
                  paused={paused}
                  onDecode={handleDecode}
                  onError={(e) => {
                    const msg = String(e?.message || e)
                    if (
                      msg.includes('scanner is not paused') ||
                      msg.includes('scanner is not scanning') ||
                      msg.includes('NotFoundError') ||
                      msg.includes('AbortError')
                    ) {
                      console.debug('[QRScannerHtml5] Ignored warning:', msg)
                      return
                    }
                    console.error('[QRScannerHtml5] Camera error:', msg)
                    setCameraError('No se pudo iniciar la cámara. Reintentá.')
                  }}
                />
              </div>
            </CardContent>
          </Card>

          {/* Modal de resultado */}
          <Dialog
            open={openResult}
            onOpenChange={(o) => {
              setOpenResult(o)
              // reanudamos solo si fue denegado (para poder reintentar)
              if (!o && allowed === false) setPaused(false)
            }}
          >
            <DialogContent className="sm:max-w-md">
              <DialogHeader>
                <DialogTitle className="sr-only">Resultado</DialogTitle>
              </DialogHeader>
              <div className="text-center py-2">
                {allowed ? (
                  <>
                    <div className="w-24 h-24 mx-auto mb-4 rounded-full bg-green-100 flex items-center justify-center">
                      <CheckCircle className="w-14 h-14 text-green-600" />
                    </div>
                    <h2 className="text-2xl font-bold text-slate-900 mb-2">¡ACCESO AUTORIZADO!</h2>
                    <p className="text-slate-700 mb-1">{fullName(member)}</p>
                    <p className="text-green-600 font-medium">{resultMsg}</p>
                  </>
                ) : (
                  <>
                    <div className="w-24 h-24 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
                      <XCircle className="w-14 h-14 text-red-600" />
                    </div>
                    <h2 className="text-2xl font-bold text-slate-900 mb-2">ACCESO DENEGADO</h2>
                    <p className="text-red-600 font-medium">{resultMsg || 'No autorizado'}</p>
                    <div className="mt-4">
                      <Button onClick={() => setOpenResult(false)}>Cerrar</Button>
                    </div>
                  </>
                )}
              </div>
            </DialogContent>
          </Dialog>
        </div>
      </div>
    </AdminLayout>
  )
}
